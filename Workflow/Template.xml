<?xml version="1.0" encoding="utf-8" ?>
<Workflow>
  <SqlQueries>
    <SqlQuery Name="CitySelectSqlQuery">
      <Text>
        select 
          city_id as "CityId",
          title as "Title",
          archive as "Archive"
         from 
          template.city
         order by title;
      </Text>
    </SqlQuery>

    <SqlQuery Name="CityInsertSqlQuery">
      <Text>
        insert into template.city(
          title,
          archive
        )
        values
          (
          {Title},
          {Archive}
          );
      </Text>
    </SqlQuery>

    <SqlQuery Name="CityUpdateSqlQuery">
      <Text>
        update template.city
        set
          title = {Title},
          archive = {Archive}
        where
          city_id = {CityId};
      </Text>
    </SqlQuery>

    <SqlQuery Name="CityDeleteSqlQuery">
      <Text>
        select template.city_try_delete({CityId}::smallint);
      </Text>
    </SqlQuery>

    <SqlQuery Name="ClientSelectSqlQuery">
      <Text>
        select
          cl.client_id as "ClientId",
          cl.title as "Name",
          ct.title as "CityTitle",
          cl.phone as "Phone"
        from
          template.client cl
          left join template.city ct using(city_id)
        order by cl.title
      </Text>
    </SqlQuery>

    <SqlQuery Name="ClientByIdSelectSqlQuery">
      <Text>
        Select
          client.title as "Name",
          client.city_id as "CityId",
          client.date_of_birth as "DateOfBirth",
          client.email as "Email",
          client.phone as "Phone" 
        from
          template.client
        where client.client_id = {ClientId};
      </Text>
    </SqlQuery>

    <SqlQuery Name="ClientInsertSqlQuery">
      <Text>
        insert into template.client(
          city_id,
          date_of_birth,
          title,
          email,
          phone
        )
        values(
          {CityId},
          {DateOfBirth},
          {Name},
          {Email},
          {Phone}
        )
        returning client_id;
      </Text>
    </SqlQuery>

    <SqlQuery Name="ClientUpdateSqlQuery">
      <Text>
        update template.client
        set
          city_id = {CityId},
          date_of_birth = {DateOfBirth},
          title = {Name},
          email = {Email},
          phone = {Phone}
        where
          client_id = {ClientId};
      </Text>
    </SqlQuery>

    <SqlQuery Name="ClientDeleteSqlQuery">
      <Text>
        delete from template.client where client_id = {ClientId};
      </Text>
    </SqlQuery>

    <SqlQuery Name="CityShortSelectSqlQuery">
      <Text>
        SELECT
          city.city_id AS "CityId",
          city.title AS "Title"
        FROM
          template.city
        where
          not city.archive or
          city.city_id = {CityId}
        ORDER BY city.title;
      </Text>
    </SqlQuery>

    <SqlQuery Name="OrderSelectSqlQuery">
      <Text>
        SELECT 
          order_id as "OrderId", 
          client_id as "ClientId",
          order_number as "OrderNumber", 
          order_date as "OrderDate", 
          order_description as "OrderDescription"
        FROM
         template."order"
        where deleted = false;
      </Text>
    </SqlQuery>

    <SqlQuery Name="OrderInsertSqlQuery">
      <Text>
        insert into template.order
          (order_number, order_date, order_description, client_id) values
          ({OrderNumber}, {OrderDate}, {OrderDescription}, {ClientId}) 
        returning order_id;
      </Text>
    </SqlQuery>

    <SqlQuery Name="OrderUpdateSqlQuery">
      <Text>
				update  template.order set
				  client_id = {ClientId},
				  order_number = {OrderNumber},
				  order_date = {OrderDate], 
				  order_description = {OrderDescription}
				where order_id = {OrderId};
      </Text>
    </SqlQuery>

    <SqlQuery Name="OrderDeleteSqlQuery">
      <Text>
        update template.order set
          deleted = True,
          date_deleted = now()
        where order_id = {OrderId};
      </Text>
    </SqlQuery>

    <SqlQuery Name="OrderSelectByIdSqlQuery">
      <Text>
        SELECT 
          order_id as "OrderId", 
          client_id as "ClientId",
          order_number as "OrderNumber", 
          order_date as "OrderDate", 
          order_description as "OrderDescription"
        FROM
         template."order"
        where
          order_id = {OrderId};
      </Text>
    </SqlQuery>

    <SqlQuery Name="ClientShortSelectSqlQuery">
      <Text>
        SELECT
          client.client_id AS "ClientId",
          client.title AS "ClientTitle",
          client.phone as "ClientPhone",
          city.title as "CityTitle"
        FROM
          template.client
          join template.city using (city_id)
        ORDER BY client.title;
      </Text>
    </SqlQuery>


  </SqlQueries>

  <Permissions>
    <Permission Name="CityViewSqlQueryPermission" Type="SqlQueryPermission">
      <SqlQueries>
        <SqlQuery Name="CitySelectSqlQuery" />
        <SqlQuery Name="CityShortSelectSqlQuery" />
      </SqlQueries>
    </Permission>
    <Permission Name="CityEditSqlQueryPermission" Type="SqlQueryPermission">
      <SqlQueries>
        <SqlQuery Name="CityInsertSqlQuery" />
        <SqlQuery Name="CityUpdateSqlQuery" />
        <SqlQuery Name="CityDeleteSqlQuery" />
      </SqlQueries>
    </Permission>

    <Permission Name="ClientViewSqlQueryPermission" Type="SqlQueryPermission">
      <SqlQueries>
        <SqlQuery Name="ClientSelectSqlQuery" />
        <SqlQuery Name="ClientByIdSelectSqlQuery" />
      </SqlQueries>
    </Permission>
    <Permission Name="ClientEditSqlQueryPermission" Type="SqlQueryPermission">
      <SqlQueries>
        <SqlQuery Name="ClientInsertSqlQuery" />
        <SqlQuery Name="ClientUpdateSqlQuery" />
        <SqlQuery Name="ClientDeleteSqlQuery" />
      </SqlQueries>
    </Permission>

    <Permission Name="OrderViewSqlQueryPermission" Type="SqlQueryPermission">
      <SqlQueries>
        <SqlQuery Name="OrderSelectSqlQuery" />
        <SqlQuery Name="OrderSelectByIdSqlQuery" />
      </SqlQueries>
    </Permission>

    <Permission Name="OrderEditSqlQueryPermission" Type="SqlQueryPermission">
      <SqlQueries>
        <SqlQuery Name="OrderInsertSqlQuery" />
        <SqlQuery Name="OrderUpdateSqlQuery" />
        <SqlQuery Name="OrderDeleteSqlQuery" />
      </SqlQueries>
    </Permission>

    <Permission Name="ClientToOrderViewSqlQueryPermission" Type="SqlQueryPermission">
      <SqlQueries>
        <SqlQuery Name="ClientShortSelectSqlQuery" />
      </SqlQueries>
    </Permission>
  </Permissions>

  <Roles>
    <Role Name="CityViewRole">
      <Permissions>
        <Permission Name="CityViewSqlQueryPermission" />
      </Permissions>
    </Role>
    <Role Name="CityEditRole">
      <Permissions>
        <Permission Name="CityViewSqlQueryPermission" />
        <Permission Name="CityEditSqlQueryPermission" />
      </Permissions>
    </Role>

    <Role Name="ClientViewRole">
      <Permissions>
        <Permission Name="ClientViewSqlQueryPermission" />
      </Permissions>
    </Role>
    <Role Name="ClientEditRole">
      <Permissions>
        <Permission Name="ClientEditSqlQueryPermission" />
        <Permission Name="ClientViewSqlQueryPermission" />
      </Permissions>
    </Role>

    <Role Name="OrderViewRole">
      <Permissions>
        <Permission Name="OrderViewSqlQueryPermission" />
        <Permission Name="ClientToOrderViewSqlQueryPermission" />
      </Permissions>
    </Role>
    <Role Name="OrderEditRole">
      <Permissions>
        <Permission Name="OrderEditSqlQueryPermission" />
        <Permission Name="OrderViewSqlQueryPermission" />
        <Permission Name="ClientToOrderViewSqlQueryPermission" />
      </Permissions>
    </Role>
  </Roles>

  <Groups>
    <Group Name="GuestGroup">
      <Roles>
        <Role Name="CityEditRole" />
        <Role Name="ClientEditRole" />
        <Role Name="OrderEditRole" />
      </Roles>
    </Group>
  </Groups>
</Workflow>