<?xml version="1.0" encoding="utf-8" ?>
<Workflow>
  <SqlQueries>
    <SqlQuery Name="CitySelectSqlQuery">
      <Text>
        select 
          city_id as "CityId",
          title as "Title",
          archive as "Archive"
         from 
          template.city
         order by title;
      </Text>
    </SqlQuery>

    <SqlQuery Name="CityInsertSqlQuery">
      <Text>
        insert into template.city(
          title,
          archive
        )
        values
          (
          {Title},
          {Archive}
          );
      </Text>
    </SqlQuery>

    <SqlQuery Name="CityUpdateSqlQuery">
      <Text>
        update template.city
        set
          title = {Title},
          archive = {Archive}
        where
          city_id = {CityId};
      </Text>
    </SqlQuery>

    <SqlQuery Name="CityDeleteSqlQuery">
      <Text>
        select template.city_try_delete({CityId}::smallint);
      </Text>
    </SqlQuery>

    <SqlQuery Name="ClientSelectSqlQuery">
      <Text>
        select
          cl.client_id as "ClientId",
          cl.title as "Name",
          ct.title as "CityTitle",
          cl.phone as "Phone",
          cl.archive as "Archive"
        from
          template.client cl
          left join template.city ct using(city_id)
        where {SearchKeyword} ISNULL or cl.title ilike '%' || {SearchKeyword} || '%'
        order by cl.title
      </Text>
    </SqlQuery>

    <SqlQuery Name="ClientByIdSelectSqlQuery">
      <Text>
        Select
          client.title as "Name",
          client.city_id as "CityId",
          client.date_of_birth as "DateOfBirth",
          client.email as "Email",
          client.phone as "Phone" 
        from
          template.client
        where client.client_id = {ClientId};
      </Text>
    </SqlQuery>

    <SqlQuery Name="ClientInsertSqlQuery">
      <Text>
        insert into template.client(
          city_id,
          date_of_birth,
          title,
          email,
          phone
        )
        values(
          {CityId},
          {DateOfBirth},
          {Name},
          {Email},
          {Phone}
        )
        returning client_id;
      </Text>
    </SqlQuery>

    <SqlQuery Name="ClientUpdateSqlQuery">
      <Text>
        update template.client
        set
          city_id = {CityId},
          date_of_birth = {DateOfBirth},
          title = {Name},
          email = {Email},
          phone = {Phone}
        where
          client_id = {ClientId};
      </Text>
    </SqlQuery>

    <SqlQuery Name="ClientDeleteSqlQuery">
      <Text>
        select template.client_try_delete({ClientId}::bigint);
      </Text>
    </SqlQuery>

    <SqlQuery Name="CityShortSelectSqlQuery">
      <Text>
        SELECT
          city.city_id AS "CityId",
          city.title AS "Title"
        FROM
          template.city
        where
          not city.archive or
          city.city_id = {CityId}
        ORDER BY city.title;
      </Text>
    </SqlQuery>

    <SqlQuery Name="OrderDeleteSelectSqlQuery">
      <Text>
     select 
      ord.order_id as "OrderId",
      ord.client_id as "ClientId",
      ord.order_number as "OrderNumber",
      ord.order_date as "OrderDate",
      ord.description as "OrderDescription",
      client.city_id as "CityId",
      ord.date_deleted as "DateDeleted"
  
    from template.order ord
    left join template.client on client.client_id = ord.client_id
        where ord.deleted and
        ord.order_date between convert_date_filter({StartDate}::timestamp) and convert_date_filter({EndDate}::timestamp);

</Text>
    </SqlQuery>

    <SqlQuery Name="OrderSelectSqlQuery">
      <Text>
    WITH _filter AS (
      SELECT
        CASE
          WHEN {Filter} = 'Today'
          THEN CURRENT_DATE::timestamp
          WHEN {Filter} = 'CurrentWeek'
          THEN date_trunc('week', CURRENT_DATE::timestamp)
          WHEN {Filter} = 'Fortnight'
          THEN date_trunc('week', CURRENT_DATE::timestamp) - interval '7d'
          WHEN {Filter} = 'Period'
          THEN {StartDate}::timestamp
        END AS start_date,
    
        CASE
          WHEN {Filter} = 'Today'
          THEN CURRENT_DATE + interval '1d - 1s'
          WHEN {Filter} = 'CurrentWeek'
          THEN date_trunc('week', CURRENT_DATE::timestamp) + interval '7d - 1s'
          WHEN {Filter} = 'Fortnight'
          THEN date_trunc('week', CURRENT_DATE::timestamp) + interval '7d - 1s'
          WHEN {Filter} = 'Period'
          THEN {EndDate}::timestamp + interval '1d - 1s'
        END AS end_date
    )  select 
		  ord.order_id as "OrderId",
		  ord.client_id as "ClientId",
		  ord.order_number as "OrderNumber",
		  ord.order_date as "OrderDate",
		  ord.description as "OrderDescription",
		  client.city_id as "CityId"
  
		from template.order ord
		left join template.client on client.client_id = ord.client_id
        left join _filter on true
        where not ord.deleted and
        ord.order_date between convert_date_filter(_filter.start_date) and convert_date_filter(_filter.end_date);
      </Text>
    </SqlQuery>

    <SqlQuery Name="OrderInsertSqlQuery">
      <Text>
        insert into template.order
          (order_number, order_date, description, client_id) values
          ({OrderNumber}, {OrderDate}, {OrderDescription}, {ClientId}) 
        returning order_id;
      </Text>
    </SqlQuery>

    <SqlQuery Name="OrderUpdateSqlQuery">
      <Text>
				update  template.order set
				  client_id = {ClientId},
				  order_number = {OrderNumber},
				  order_date = {OrderDate}, 
				  description = {OrderDescription}
				where order_id = {OrderId};
      </Text>
    </SqlQuery>

    <SqlQuery Name="OrderDeleteSqlQuery">
      <Text>
        update template.order set
          deleted = True,
          date_deleted = now()
        where order_id = {OrderId};
      </Text>
    </SqlQuery>

    <SqlQuery Name="OrderSelectByIdSqlQuery">
      <Text>
        SELECT 
          client_id as "ClientId",
          order_number as "OrderNumber", 
          order_date as "OrderDate", 
          description as "OrderDescription"
        FROM
         template."order"
        where
          order_id = {OrderId};
      </Text>
    </SqlQuery>

    <SqlQuery Name="ClientShortSelectSqlQuery">
      <Text>
        SELECT
          client.client_id AS "ClientId",
          client.title AS "ClientTitle",
          client.phone as "ClientPhone",
          city.title as "CityTitle"
        FROM
          template.client
          join template.city using (city_id)
        where
          not client.archive or
          client.client_id = {ClientId}
        ORDER BY client.title;
      </Text>
    </SqlQuery>

    <SqlQuery Name="ClientSimpleSqlQuery">
      <Text>
        select
          client.client_id as "ClientId",
          client.title as "ClientTitle"
        from template.client
      </Text>
    </SqlQuery>

    <SqlQuery Name="CitySimpleSqlQuery">
      <Text>
        select
	        city.city_id as "CityId",
	        city.title as "CityTitle"
        from template.city
      </Text>
    </SqlQuery>

    <SqlQuery Name="ClientArchiveSqlQuery">
      <Text>
        update template.client
          set archive = not archive where client_id = {ClientId};
      </Text>
    </SqlQuery>

    <!--============================================================-->
    <!--===Единицы измерения===-->
    <!--============================================================-->
    <SqlQuery Name="UnitSelectSqlQuery">
      <Text>  
        SELECT
          unit.unit_id AS "UnitId",
          unit.title AS "Title",
          unit.short_title as "ShortTitle",
          unit.archive AS "Archive"
        FROM
          template.unit
        ORDER BY unit.title;
      </Text>
    </SqlQuery>

    <SqlQuery Name="UnitByIdSelectSqlQuery">
      <Text>
        SELECT
          unit.unit_id AS "UnitId",
          unit.title AS "Title"
        FROM
          template.unit
        WHERE
          unit.unit_id = {UnitId};
      </Text>
    </SqlQuery>

    <SqlQuery Name="UnitInsertSqlQuery">
      <Text>
    	INSERT INTO template.unit (
    	  title
    	)
    	VALUES (
    	  {Title}
    	)
    	RETURNING unit_id;
      </Text>
    </SqlQuery>

    <SqlQuery Name="UnitUpdateSqlQuery">
      <Text>
        UPDATE template.unit
        SET
          title = {Title}
        WHERE
          unit_id = {UnitId};
      </Text>
    </SqlQuery>

    <SqlQuery Name="UnitArchiveUpdateSqlQuery">
      <Text>
        UPDATE template.unit
        SET
          archive = NOT archive
        WHERE
          unit_id = {UnitId};
      </Text>
    </SqlQuery>

    <SqlQuery Name="UnitDeleteSqlQuery">
      <Text>
        SELECT template.unit_try_delete({UnitId});
      </Text>
    </SqlQuery>

    <!--============================================================-->
    <!--===Категория ТМЦ===-->
    <!--============================================================-->
    <SqlQuery Name="MaterialCategoryByIdSelectSqlQuery">
      <Text>
        SELECT
          material_category.title AS "Title",
          material_category.parent_material_category_id as "ParentMaterialCategoryId"
        FROM
          template.material_category
        WHERE
          material_category.material_category_id = {MaterialCategoryId};
      </Text>
    </SqlQuery>

    <SqlQuery Name="MaterialCategoryInsertSqlQuery">
      <Text>
    	INSERT INTO template.material_category (
    	  title,
          parent_material_category_id
    	)
    	VALUES (
    	  {Title},
          {ParentMaterialCategoryId}
    	)
    	RETURNING material_category_id;
      </Text>
    </SqlQuery>

    <SqlQuery Name="MaterialCategoryUpdateSqlQuery">
      <Text>
        UPDATE template.material_category
        SET
          title = {Title}, parent_material_category_id = {ParentMaterialCategoryId}
        WHERE
          material_category_id = {MaterialCategoryId};
      </Text>
    </SqlQuery>

    <SqlQuery Name="ParentMaterialCategorySelectSqlQuery">
      <Text>
         WITH RECURSIVE tree_tmp (material_category_id, parent_material_category_id, title, path) AS (
      SELECT material_category_id, parent_material_category_id, title, ARRAY[material_category_id]::bigint[]
      FROM parent_mc
    
      UNION ALL
    
      SELECT MC.material_category_id, MC.parent_material_category_id, MC.title, T.path || ARRAY[MC.material_category_id]::bigint[]
      FROM
        mc_tmp MC
      JOIN tree_tmp T ON T.material_category_id = MC.parent_material_category_id
    ), mc_tmp AS (
      SELECT *
      FROM template.material_category
      WHERE material_category_id IS DISTINCT FROM {MaterialCategoryId} OR {WithChild}
    ), parent_mc AS (
      SELECT *
      FROM mc_tmp
      WHERE parent_material_category_id IS NULL
    )
    
    SELECT
      T.material_category_id AS "MaterialCategoryId",
      CASE WHEN array_length(T.path, 1) > 1 THEN COALESCE(repeat('—', (array_length(T.path, 1) - 1)), '') || ' ' ELSE '' END || T.title  AS "Title"
    FROM
      tree_tmp T
      ORDER BY T.path, T.material_category_id;
      </Text>
    </SqlQuery>

    <SqlQuery Name="MaterialCategoryListSqlQuery">
      <Text>
        <!--         Select
          mc.material_category_id as "MaterialCategoryId",
          case when mc.archive then mc.title || '[арх.]' else mc.title end,
          mc.archive as "Archive"
          from
          template.material_category mc
          order by mc.title, mc.material_category_id;-->

        SELECT MC.material_category_id AS "MaterialCategoryId", MC.title || CASE WHEN archive THEN ' (арх.)' ELSE '' END AS "Title", MC.title AS "OriginalTitle", MC.archive AS "Archive", MC2.material_category_id NOTNULL AS "ArchiveForFilter" FROM template.material_category MC LEFT JOIN ( WITH RECURSIVE archive_tree (material_category_id, parent_material_category_id) AS( SELECT material_category_id, parent_material_category_id FROM template.material_category MC WHERE MC.archive AND NOT EXISTS (SELECT * FROM template.material_category MC2 WHERE MC2.parent_material_category_id = MC.material_category_id) OR EXISTS (SELECT * FROM template.material M WHERE M.archive AND M.material_category_id = MC.material_category_id)

        UNION

        SELECT MC.material_category_id, MC.parent_material_category_id FROM template.material_category MC JOIN archive_tree T ON (T.parent_material_category_id = MC.material_category_id) ) SELECT DISTINCT material_category_id FROM archive_tree ) MC2 ON (MC2.material_category_id = MC.material_category_id) ORDER BY MC.title, MC.material_category_id;
      </Text>
    </SqlQuery>

    <SqlQuery Name="MaterialCategoryRelationSqlQuery">
      <Text>
        select material_category_id as "MaterialCategoryId",
          parent_material_category_id as "ParentMaterialCategoryId"
         from 
          template.material_category;         
      </Text>
    </SqlQuery>

    <SqlQuery Name="MaterialCategoryDeleteSqlQuery">
      <Text>
        Select template.material_category_try_delete({MaterialCategoryId}::bigint);
      </Text>
    </SqlQuery>

    <SqlQuery Name="MaterialCategoryDeleteCascadeSqlQuery">
      <Text>
        select template.material_category_delete_cascade({MaterialCategoryId}::bigint);
      </Text>
    </SqlQuery>

    <SqlQuery Name="MaterialCategoryArchiveSqlQuery">
      <Text>
	    UPDATE template.material_category
	    SET archive = {Archive}
	    WHERE material_category_id = {MaterialCategoryId};
	
	    SELECT template.material_category_archive_child({MaterialCategoryId})
	    WHERE {Archive};
	    
	    SELECT template.material_category_unarchive_parent({MaterialCategoryId})
	    WHERE not  {Archive};
      </Text>
    </SqlQuery>

    <!--============================================================-->
    <!--===Товарно-материальные ценности===-->
    <!--============================================================-->
    <SqlQuery Name="MaterialSelectSqlQuery">
      <Text>  
        SELECT
		  m.material_id AS "MaterialId",
		  m.title AS "Title",
		  m.material_category_id as "MaterialCategoryId",
		  m.unit_id as "UnitId",
		  m.unit_price as "UnitPrice",
		  m.archive as "Archive"
		FROM
		  template.material m
		ORDER BY m.title;
      </Text>
    </SqlQuery>

    <SqlQuery Name="MaterialByIdSelectSqlQuery">
      <Text>
        SELECT
	      M.material_category_id AS "MaterialCategoryId",
	      M.title AS "Title",
	      M.unit_id AS "UnitId",
	      M.unit_price AS "UnitPrice"
	    FROM
	      template.material M
	    WHERE
	      M.material_id = {MaterialId};
      </Text>
    </SqlQuery>

    <SqlQuery Name="MaterialInsertSqlQuery">
      <Text>
	    INSERT INTO template.material (
	      title,
	      material_category_id,
	      unit_id,
	      unit_price
	    )
	    VALUES (
	      {Title},
	      {MaterialCategoryId},
	      {UnitId},
	      {UnitPrice}
	    )
	    RETURNING material_id;
      </Text>
    </SqlQuery>

    <SqlQuery Name="MaterialUpdateSqlQuery">
      <Text>
	    UPDATE template.material
	    SET
	      title = {Title},
	      material_category_id = {MaterialCategoryId},
	      unit_id = {UnitId},
	      unit_price = {UnitPrice}
	    WHERE
	      material_id = {MaterialId};
      </Text>
    </SqlQuery>

    <SqlQuery Name="MaterialDeleteSqlQuery">
      <Text>
        SELECT template.material_try_delete({MaterialId});
      </Text>
    </SqlQuery>

    <SqlQuery Name="MaterialArchiveSqlQuery">
      <Text>
	    UPDATE template.material
	    SET archive = {Archive}
	    WHERE material_id = {MaterialId};
	
	    UPDATE template.material_category MC
	    SET archive = False
	    FROM template.material M
	    WHERE
	      MC.material_category_id = M.material_category_id AND
	      material_id = {MaterialId} AND
	      NOT M.archive;
	
	    SELECT template.material_category_unarchive_parent(M.material_category_id)
	    FROM template.material M
	    WHERE
	      M.material_id = {MaterialId} AND
	      NOT M.archive;
      </Text>
    </SqlQuery>

    <SqlQuery Name="UnitShortSelectSqlQuery">
      <Text>
        SELECT
          unit.unit_id AS "UnitId",
          unit.title AS "Title",
          unit.archive as "Archive"
        FROM
          template.unit
        ORDER BY unit.title;
      </Text>
    </SqlQuery>



  </SqlQueries>

  <Permissions>
    <Permission Name="CityViewSqlQueryPermission" Type="SqlQueryPermission">
      <SqlQueries>
        <SqlQuery Name="CitySelectSqlQuery" />
        <SqlQuery Name="CityShortSelectSqlQuery" />
      </SqlQueries>
    </Permission>
    <Permission Name="CityEditSqlQueryPermission" Type="SqlQueryPermission">
      <SqlQueries>
        <SqlQuery Name="CityInsertSqlQuery" />
        <SqlQuery Name="CityUpdateSqlQuery" />
        <SqlQuery Name="CityDeleteSqlQuery" />
      </SqlQueries>
    </Permission>

    <Permission Name="ClientViewSqlQueryPermission" Type="SqlQueryPermission">
      <SqlQueries>
        <SqlQuery Name="ClientSelectSqlQuery" />
        <SqlQuery Name="ClientByIdSelectSqlQuery" />
      </SqlQueries>
    </Permission>
    <Permission Name="ClientEditSqlQueryPermission" Type="SqlQueryPermission">
      <SqlQueries>
        <SqlQuery Name="ClientInsertSqlQuery" />
        <SqlQuery Name="ClientUpdateSqlQuery" />
        <SqlQuery Name="ClientDeleteSqlQuery" />
        <SqlQuery Name="ClientArchiveSqlQuery" />
      </SqlQueries>
    </Permission>

    <Permission Name="OrderViewSqlQueryPermission" Type="SqlQueryPermission">
      <SqlQueries>
        <SqlQuery Name="OrderSelectSqlQuery" />
        <SqlQuery Name="OrderSelectByIdSqlQuery" />
        <SqlQuery Name="CitySimpleSqlQuery" />
        <SqlQuery Name="ClientShortSelectSqlQuery" />
        <SqlQuery Name="ClientSimpleSqlQuery" />
        <SqlQuery Name="OrderDeleteSelectSqlQuery" />
      </SqlQueries>
    </Permission>

    <Permission Name="OrderEditSqlQueryPermission" Type="SqlQueryPermission">
      <SqlQueries>
        <SqlQuery Name="OrderInsertSqlQuery" />
        <SqlQuery Name="OrderUpdateSqlQuery" />
        <SqlQuery Name="OrderDeleteSqlQuery" />
      </SqlQueries>
    </Permission>

    <Permission Name="UnitViewSqlQueryPermission" Type="SqlQueryPermission">
      <SqlQueries>
        <SqlQuery Name="UnitSelectSqlQuery" />
        <SqlQuery Name="UnitByIdSelectSqlQuery" />
      </SqlQueries>
    </Permission>

    <Permission Name="UnitEditSqlQueryPermission" Type="SqlQueryPermission">
      <SqlQueries>
        <SqlQuery Name="UnitInsertSqlQuery" />
        <SqlQuery Name="UnitUpdateSqlQuery" />
        <SqlQuery Name="UnitArchiveUpdateSqlQuery" />
        <SqlQuery Name="UnitDeleteSqlQuery" />
      </SqlQueries>
    </Permission>

    <Permission Name="MaterialCategoryViewSqlQueryPermission" Type="SqlQueryPermission">
      <SqlQueries>
        <SqlQuery Name="MaterialCategoryByIdSelectSqlQuery" />
        <SqlQuery Name="ParentMaterialCategorySelectSqlQuery" />
        <SqlQuery Name="MaterialCategoryListSqlQuery" />
        <SqlQuery Name="MaterialCategoryRelationSqlQuery" />
      </SqlQueries>
    </Permission>

    <Permission Name="MaterialCategoryEditSqlQueryPermission" Type="SqlQueryPermission">
      <SqlQueries>
        <SqlQuery Name="MaterialCategoryInsertSqlQuery" />
        <SqlQuery Name="MaterialCategoryUpdateSqlQuery" />
        <SqlQuery Name="MaterialCategoryDeleteCascadeSqlQuery" />
        <SqlQuery Name="MaterialCategoryDeleteSqlQuery" />
        <SqlQuery Name="MaterialCategoryArchiveSqlQuery" />
      </SqlQueries>
    </Permission>

    <Permission Name="MaterialViewSqlQueryPermission" Type="SqlQueryPermission">
      <SqlQueries>
        <SqlQuery Name="MaterialSelectSqlQuery" />
        <SqlQuery Name="MaterialByIdSelectSqlQuery" />
      </SqlQueries>
    </Permission>

    <Permission Name="MaterialEditSqlQueryPermission" Type="SqlQueryPermission">
      <SqlQueries>
        <SqlQuery Name="MaterialInsertSqlQuery" />
        <SqlQuery Name="MaterialUpdateSqlQuery" />
        <SqlQuery Name="MaterialDeleteSqlQuery" />
        <SqlQuery Name="UnitShortSelectSqlQuery" />
        <SqlQuery Name="MaterialArchiveSqlQuery" />
      </SqlQueries>
    </Permission>

  </Permissions>

  <Roles>
    <Role Name="CityViewRole">
      <Permissions>
        <Permission Name="CityViewSqlQueryPermission" />
      </Permissions>
    </Role>
    <Role Name="CityEditRole">
      <Permissions>
        <Permission Name="CityViewSqlQueryPermission" />
        <Permission Name="CityEditSqlQueryPermission" />
      </Permissions>
    </Role>

    <Role Name="ClientViewRole">
      <Permissions>
        <Permission Name="ClientViewSqlQueryPermission" />
      </Permissions>
    </Role>
    <Role Name="ClientEditRole">
      <Permissions>
        <Permission Name="ClientEditSqlQueryPermission" />
        <Permission Name="ClientViewSqlQueryPermission" />
      </Permissions>
    </Role>

    <Role Name="OrderViewRole">
      <Permissions>
        <Permission Name="OrderViewSqlQueryPermission" />
      </Permissions>
    </Role>
    <Role Name="OrderEditRole">
      <Permissions>
        <Permission Name="OrderEditSqlQueryPermission" />
        <Permission Name="OrderViewSqlQueryPermission" />
      </Permissions>
    </Role>

    <Role Name="UnitViewRole">
      <Permissions>
        <Permission Name="UnitViewSqlQueryPermission" />
      </Permissions>
    </Role>
    <Role Name="UnitEditRole">
      <Permissions>
        <Permission Name="UnitViewSqlQueryPermission" />
        <Permission Name="UnitEditSqlQueryPermission" />
      </Permissions>
    </Role>

    <Role Name="MaterialCategoryViewRole">
      <Permissions>
        <Permission Name="MaterialCategoryViewSqlQueryPermission" />
      </Permissions>
    </Role>
    <Role Name="MaterialCategoryEditRole">
      <Permissions>
        <Permission Name="MaterialCategoryViewSqlQueryPermission" />
        <Permission Name="MaterialCategoryEditSqlQueryPermission" />
      </Permissions>
    </Role>

    <Role Name="MaterialViewRole">
      <Permissions>
        <Permission Name="MaterialViewSqlQueryPermission" />
      </Permissions>
    </Role>
    <Role Name="MaterialEditRole">
      <Permissions>
        <Permission Name="MaterialViewSqlQueryPermission" />
        <Permission Name="MaterialEditSqlQueryPermission" />
      </Permissions>
    </Role>
  </Roles>

  <Groups>
    <Group Name="GuestGroup">
      <Roles>
        <Role Name="CityEditRole" />
        <Role Name="ClientEditRole" />
        <Role Name="OrderEditRole" />
        <Role Name="UnitEditRole" />
        <Role Name="MaterialCategoryEditRole" />
        <Role Name="MaterialEditRole" />
      </Roles>
    </Group>


  </Groups>
</Workflow>